<!-- SillyTavern/data/your_user_handle/extensions/remove-br-tags-extension/settings_display.html -->
<div class="br-tags-visibility-settings">
    <h4>BR标签显隐设置</h4>
    <div class="inline-drawer">
        <div class="fields">
            <!-- 开关一：仅聊天消息 -->
            <div class="field">
                <div class="field_inline">
                    <label for="ext_hide_chat_br_toggle">隐藏聊天消息中的 <br> 标签</label>
                    <input type="checkbox" id="ext_hide_chat_br_toggle" />
                </div>
                <div class="description">
                    选中后，仅聊天消息区域的 <br> 换行标签将被视觉上隐藏。
                </div>
            </div>

            <!-- 开关二：整个界面 -->
            <div class="field">
                <div class="field_inline">
                    <label for="ext_hide_all_br_toggle">隐藏整个界面的 <br> 标签</label>
                    <input type="checkbox" id="ext_hide_all_br_toggle" />
                </div>
                <div class="description">
                    选中后，SillyTavern 整个界面中的所有 <br> 换行标签将被视觉上隐藏。
                    <strong>注意:</strong> 此选项会覆盖上面的 "仅聊天消息" 选项。
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function() {
        // 确保 SillyTavern 上下文和核心API在脚本执行时可用
        if (!window.SillyTavern || !window.SillyTavern.getContext || !window.SillyTavern.extension_settings || !window.SillyTavern.saveSettingsDebounced) {
            console.error("BR标签显隐控制 (settings): SillyTavern core objects (getContext, extension_settings, saveSettingsDebounced) not found.");
            return;
        }

        const { extension_settings, saveSettingsDebounced } = SillyTavern;

        // 插件的文件夹名称，将用作设置的键
        const PLUGIN_FOLDER_NAME = 'remove-br-tags-extension';

        const chatBrToggle = document.getElementById('ext_hide_chat_br_toggle');
        const allBrToggle = document.getElementById('ext_hide_all_br_toggle');

        if (!chatBrToggle || !allBrToggle) {
            console.error(`BR标签显隐控制 (settings - ${PLUGIN_FOLDER_NAME}): Toggle checkboxes not found.`);
            return;
        }

        // 获取或初始化此插件的设置
        function getPluginSettings() {
            const defaultSettings = {
                hideChatBr: false,
                hideAllBr: false
            };
            if (!extension_settings[PLUGIN_FOLDER_NAME]) {
                extension_settings[PLUGIN_FOLDER_NAME] = { ...defaultSettings };
            } else {
                // 确保所有默认键都存在，以处理插件更新后可能新增的设置项
                for (const key in defaultSettings) {
                    if (typeof extension_settings[PLUGIN_FOLDER_NAME][key] === 'undefined') {
                        extension_settings[PLUGIN_FOLDER_NAME][key] = defaultSettings[key];
                    }
                }
            }
            return extension_settings[PLUGIN_FOLDER_NAME];
        }

        // 加载设置并更新UI复选框的状态
        function loadSettingsToUI() {
            const settings = getPluginSettings();
            chatBrToggle.checked = settings.hideChatBr;
            allBrToggle.checked = settings.hideAllBr;

            // 初始加载时，也触发一次样式应用 (通过调用 index.js 中暴露的函数)
            // 确保 window.extensions.removeBrTagsExtension 结构存在 (与 index.js 中暴露的名称一致)
            if (window.extensions && window.extensions[PLUGIN_FOLDER_NAME] && typeof window.extensions[PLUGIN_FOLDER_NAME].applyVisibility === 'function') {
                window.extensions[PLUGIN_FOLDER_NAME].applyVisibility(settings);
            }
        }

        // 当复选框状态改变时，调用此函数以触发 index.js 中的样式更新
        function triggerApplyVisibilityFromIndex(currentSettings) {
            if (window.extensions && window.extensions[PLUGIN_FOLDER_NAME] && typeof window.extensions[PLUGIN_FOLDER_NAME].applyVisibility === 'function') {
                window.extensions[PLUGIN_FOLDER_NAME].applyVisibility(currentSettings);
            } else {
                console.warn(`BR标签显隐控制 (settings - ${PLUGIN_FOLDER_NAME}): index.js 中的 applyVisibility 函数未找到。`);
            }
        }

        // 监听聊天BR显隐开关的变化
        chatBrToggle.addEventListener('change', function() {
            const settings = getPluginSettings();
            settings.hideChatBr = this.checked;
            saveSettingsDebounced(); // 保存更改到 SillyTavern 的持久化存储
            triggerApplyVisibilityFromIndex(settings); // 立即应用视觉更改
        });

        // 监听整个界面BR显隐开关的变化
        allBrToggle.addEventListener('change', function() {
            const settings = getPluginSettings();
            settings.hideAllBr = this.checked;
            saveSettingsDebounced();
            triggerApplyVisibilityFromIndex(settings);
        });

        // 初始加载设置到UI
        loadSettingsToUI();

        console.log(`BR标签显隐控制 (settings for ${PLUGIN_FOLDER_NAME}): UI script initialized.`);
    })();
</script>
